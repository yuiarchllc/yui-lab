# 要件定義書

## はじめに

このドキュメントは、AWS Bedrock Knowledge Baseを活用したRAG (Retrieval-Augmented Generation) システムのインフラストラクチャ要件を定義します。システムは、多様な形式のドキュメントの保存、ベクトル化、検索、そしてLLMによる回答生成を統合的に提供します。

## 用語集

- **RAGシステム**: ドキュメント検索と生成AIを組み合わせたシステム
- **ナレッジベース**: AWS Bedrock Knowledge Base - ベクトル検索とドキュメント管理を提供するサービス
- **ベクトルストア**: S3 Vectors - ベクトルデータを保存・検索するためのストレージ
- **データソースバケット**: ソースドキュメントを保存するS3バケット
- **埋め込みモデル**: テキストをベクトルに変換するモデル (Amazon Titan Embed Text v2)
- **LLM**: Large Language Model - 回答生成に使用する大規模言語モデル
- **Terraformモジュール**: 再利用可能なインフラストラクチャコードの単位
- **Bedrockエージェント**: AWS Bedrock Agent - ナレッジベースと統合し、会話履歴を自動管理するエージェント機能
- **アクショングループ**: エージェントが実行できる特定のタスクやAPIの集合
- **セッション**: ユーザーとエージェント間の一連の会話のやり取り

## 要件

### 要件1: Terraformによるインフラ管理

**ユーザーストーリー:** インフラエンジニアとして、RAGシステムのインフラストラクチャをTerraformで管理したい。これにより、環境の再現性と保守性を確保できる。

#### 受け入れ基準

1. Terraformモジュールは、RAGシステムに必要なすべてのAWSリソースを宣言的な設定ファイルで定義しなければならない
2. Terraformモジュールは、プロジェクト名とAWSリージョンの設定可能な変数を受け入れなければならない
3. Terraformモジュールは、ナレッジベースID、データソースバケット名、ベクトルストアARNを含む重要なリソース識別子を出力しなければならない
4. Terraformモジュールは、AWSサービスのカテゴリに基づいてリソースを論理的なファイルに整理しなければならない
5. Terraformモジュールは、試作環境向けに簡単なクリーンアップのためforce_destroyを有効にしなければならない

### 要件2: ドキュメントの安全な保存と自動ベクトル化

**ユーザーストーリー:** システム管理者として、多様な形式のドキュメントを安全に保存し、自動的にベクトル化したい。これにより、検索可能なナレッジベースを構築できる。

#### 受け入れ基準

1. RAGシステムは、ソースドキュメントを保存するためのバージョニングが有効なS3バケットを作成しなければならない
2. RAGシステムは、データソースバケット内のすべてのオブジェクトにAES256を使用したサーバーサイド暗号化を適用しなければならない
3. RAGシステムは、データソースバケットへのすべてのパブリックアクセスをブロックしなければならない
4. ドキュメントがデータソースバケットにアップロードされたとき、ナレッジベースはドキュメントの内容を自動的に処理してベクトル化しなければならない
5. RAGシステムは、ユークリッド距離メトリックを使用したS3 Vectorsインデックスにベクトル埋め込みを保存しなければならない

### 要件3: 多様なファイル形式のサポート

**ユーザーストーリー:** ビジネスユーザーとして、様々な形式のドキュメントをナレッジベースに登録したい。これにより、既存の業務ドキュメントを活用できる。

#### 受け入れ基準

1. ナレッジベースは、任意の文字コード（UTF-8、Shift-JIS、EUC-JPなど）のテキストファイルを処理しなければならない
2. ナレッジベースは、任意の文字コードのCSVファイルを処理しなければならない
3. ナレッジベースは、Microsoft Excel形式（.xlsx、.xls）のファイルを処理しなければならない
4. ナレッジベースは、Microsoft Word形式（.docx、.doc）のファイルを処理しなければならない
5. ナレッジベースは、Microsoft PowerPoint形式（.pptx、.ppt）のファイルを処理しなければならない
6. ナレッジベースは、テキストベースのPDFファイルを処理しなければならない
7. ナレッジベースは、画像をPDF化したファイル（スキャンPDF）をOCR処理して内容を抽出しなければならない

### 要件4: 最小権限のIAMロール設定

**ユーザーストーリー:** セキュリティ管理者として、最小権限の原則に基づいたIAMロールを設定したい。これにより、セキュリティリスクを最小化できる。

#### 受け入れ基準

1. RAGシステムは、Bedrockサービスのみが引き受けることができるIAMロールを作成しなければならない
2. IAMロールは、同じAWSアカウント内のナレッジベースとエージェントリソースに対してのみロールの引き受けを制限しなければならない
3. IAMロールは、指定された埋め込みモデルとLLMモデルの呼び出し権限のみを付与しなければならない
4. IAMロールは、指定されたデータソースバケットとベクトルストアへのアクセス権限のみを付与しなければならない
5. IAMロールは、S3またはBedrockリソースに対するワイルドカード権限を付与してはならない

### 要件5: ナレッジベースのクエリ実行

**ユーザーストーリー:** 開発者として、ナレッジベースに対してクエリを実行し、関連ドキュメントを取得したい。これにより、RAG機能を実装できる。

#### 受け入れ基準

1. ナレッジベースは、1024次元のAmazon Titan Embed Text v2モデルをベクトル埋め込みに使用しなければならない
2. ナレッジベースは、FLOAT32データ型を使用するように埋め込みモデルを設定しなければならない
3. ナレッジベースは、ベクトルの保存と検索のためにS3 Vectorsインデックスと統合しなければならない
4. ナレッジベースは、ドキュメント取り込みのためにS3データソースに接続しなければならない
5. ナレッジベースは、自然言語テキスト入力によるクエリをサポートしなければならない

### 要件6: Bedrock Agentによる会話履歴管理

**ユーザーストーリー:** ユーザーとして、会話の文脈を保持してより自然な対話を実現したい。これにより、過去のやり取りを踏まえた回答を得ることができる。

#### 受け入れ基準

1. RAGシステムは、ナレッジベースと統合されたBedrock Agentを作成しなければならない
2. Bedrock Agentは、会話履歴を自動的に保持して文脈を考慮した応答を生成しなければならない
3. Bedrock Agentは、指定されたLLMモデル（Claude 3など）を使用して回答を生成しなければならない
4. Bedrock Agentは、ナレッジベースから取得した情報を使用して回答を生成しなければならない
5. IAMロールは、Bedrock AgentがナレッジベースとLLMモデルにアクセスできる権限を付与しなければならない

### 要件7: アプリケーション統合のための出力

**ユーザーストーリー:** アプリケーション開発者として、RAGシステムの設定情報を簡単に取得したい。これにより、マネジメントコンソールやアプリケーションコードからエージェントを利用できる。

#### 受け入れ基準

1. Terraformモジュールは、アプリケーション統合のためにBedrock Agent IDを出力しなければならない
2. Terraformモジュールは、アプリケーション統合のためにBedrock Agent Aliasを出力しなければならない
3. Terraformモジュールは、アプリケーション統合のためにナレッジベースIDを出力しなければならない
4. Terraformモジュールは、ドキュメントアップロード操作のためにデータソースバケット名を出力しなければならない
5. Terraformモジュールは、他のモジュールでの参照のためにIAMロールARNを出力しなければならない
6. Terraformモジュールは、説明的なラベルとドキュメントを含むすべての出力をフォーマットしなければならない
